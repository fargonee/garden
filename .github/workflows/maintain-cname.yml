name: Restore CNAME for Digital Garden

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - main # or your source branch

jobs:
  restore-cname:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # fetch full history, required for branch operations

      # 2. Ensure gh_pages branch exists
      - name: Checkout or create gh_pages branch
        run: |
          git fetch origin gh-pages || true
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi

      # 3. Restore the CNAME file
      - name: Add or update CNAME
        run: |
          echo "garden.fargonee.space" > CNAME
          git add CNAME
          git commit -m "Restore CNAME for GitHub Pages" || echo "No changes to commit"

      # 4. Push changes back to gh_pages
      - name: Push to gh-pages
        run: |
          git push origin gh-pages --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
