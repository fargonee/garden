<script>
document.addEventListener("DOMContentLoaded", () => {
  console.clear();
  console.log("Dynamic Language Switcher v2025");

  // ---------------------------------------------------------
  // Utility: extract slug from href (no trailing slash)
  // ---------------------------------------------------------
  const getSlugFromHref = (href) => {
    try {
      const url = new URL(href, location.origin);
      const clean = url.pathname.replace(/\/+$/, "");
      const parts = clean.split("/").filter(Boolean);
      return parts.length ? parts.pop() : "";
    } catch {
      return "";
    }
  };

  // ---------------------------------------------------------
  // STEP 1: Collect all candidate slugs from sidebar
  // ---------------------------------------------------------
  const anchors = [...document.querySelectorAll("a.filename")];
  const slugs = anchors
    .map(a => a.getAttribute("href"))
    .filter(href => href && href !== "/")
    .map(getSlugFromHref)
    .filter(Boolean);

  // ---------------------------------------------------------
  // STEP 2: Infer languages by detecting repeated suffixes
  // ---------------------------------------------------------
  const langCounts = {};

  for (const slug of slugs) {
    const match = slug.match(/-([a-z]{2,3})$/);
    if (match) {
      const lang = match[1];
      langCounts[lang] = (langCounts[lang] || 0) + 1;
    }
  }

  const LANGS = Object.keys(langCounts)
    .filter(lang => langCounts[lang] > 1) // avoid accidental singletons
    .sort()                               // stable order
    .reduce((acc, lang) => {
      acc[lang] = lang.toUpperCase();
      return acc;
    }, {});

  if (Object.keys(LANGS).length === 0) {
    console.log("No language patterns detected.");
    return;
  }

  console.log("Languages detected:", LANGS);

  // ---------------------------------------------------------
  // STEP 3: Detect current slug, baseDir, current language
  // ---------------------------------------------------------
  const rawPath = location.pathname.replace(/\/+$/, "") || "/";
  const parts = rawPath.split("/").filter(Boolean);
  const slug = parts.length ? parts[parts.length - 1] : "";
  const baseDir = parts.length > 1
    ? "/" + parts.slice(0, -1).join("/") + "/"
    : "/";

  const currentLang =
    slug.match(/-([a-z]{2,3})$/)?.[1] || Object.keys(LANGS)[0];

  const baseName = slug.replace(/-[a-z]{2,3}$/, "");

  console.log("Current:", { slug, baseDir, baseName, currentLang });

  // ---------------------------------------------------------
  // STEP 4: Detect home page base name from sidebar link
  // ---------------------------------------------------------
  const getHomeBaseName = () => {
    const link = document.querySelector(
      'a[href="/"].filename, a[href="./"].filename, a[href="/"] .filename'
    );
    console.log("link textcontent", link.textContent)
    if (!link?.textContent) return "home";

    let name =  link.textContent
      .trim()
      .toLowerCase()
      .replace(/\s+/g, "-")
      .replace(/[^\w-]/g, "")
      .replace(/-[a-z]{2,3}$/, "");
    // Remove any detected language suffix at the very end
    for (const suffix of Object.keys(LANGS)) {
      const regex = new RegExp(`${suffix}$`);
      if (regex.test(name)) {
        name = name.replace(regex, "");
        break;
      }
    }
    return name;
  };
  

  const homeBase = getHomeBaseName();
  console.log("Home base:", homeBase);

  // ---------------------------------------------------------
  // STEP 5: Build target URLs
  // ---------------------------------------------------------
  const buildTargetUrl = (targetLang) => {
    const isRoot = rawPath === "/";
    const isHomePage = baseName === homeBase;

    if (isRoot) {
      return targetLang === Object.keys(LANGS)[0]
        ? "/"
        : "/" + homeBase + "-" + targetLang;
    }

    if (isHomePage) {
      return targetLang === Object.keys(LANGS)[0]
        ? "/"
        : "/" + homeBase + "-" + targetLang;
    }

    return baseDir + baseName + "-" + targetLang;
  };

  // ---------------------------------------------------------
  // STEP 6: Create language switcher
  // ---------------------------------------------------------
  const switcher = document.createElement("div");
  switcher.className = "lang-switcher";

  for (const [code, label] of Object.entries(LANGS)) {
    const btn = document.createElement("button");
    btn.textContent = label;

    if (code === currentLang) {
      btn.classList.add("active");
    }

    btn.onclick = async () => {
      if (code === currentLang) return;

      const targetUrl = buildTargetUrl(code);
      console.log(`Switch → ${currentLang} → ${code}:`, targetUrl);

      try {
        const res = await fetch(targetUrl, { method: "HEAD" });
        if (res.ok) location.href = targetUrl;
      } catch (err) {
        console.log("Fetch error:", err);
      }
    };

    switcher.appendChild(btn);
  }

  document.body.appendChild(switcher);
  console.log("Dynamic switcher initialized");
});
</script>





<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script async type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
</script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-sv0slik/5O0JIPdLBCR2A3XDg/1U3WuDEheZfI/DI5n8Yqc3h5kjrnr46FGBNiUAJF7rE4LHKwQ/SoSLRKAxEA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

{%include "components/calloutScript.njk"%}

<script async src="https://fastly.jsdelivr.net/npm/force-graph@1.43.0/dist/force-graph.min.js"></script>

<script async src="https://fastly.jsdelivr.net/npm/@alpinejs/persist@3.11.1/dist/cdn.min.js"></script>
<script src="https://fastly.jsdelivr.net/npm/alpinejs@3.11.1/dist/cdn.min.js" async></script>


<script>
// 2025 Smart Bilingual Garden – English filenames + Uzbek titles in UI
document.addEventListener("DOMContentLoaded", () => {
  const uzbekMode = location.search.includes("lang=uz");

  // Language switcher buttons
  const div = document.createElement("div");
  div.innerHTML = `
    <button onclick="location.search='lang=uz'"   style="font-weight:${uzbekMode?'bold':'normal'}">UZ</button>
    <button onclick="location.search=''"          style="font-weight:${!uzbekMode?'bold':'normal'}">EN</button>
  `;
  Object.assign(div.style, {
    position:"fixed", top:"12px", right:"20px", zIndex:9999,
    background:"var(--background-primary)", padding:"8px 14px",
    borderRadius:"10px", boxShadow:"0 2px 10px rgba(0,0,0,0.2)",
    fontSize:"15px", display:"flex", gap:"12px"
  });
  document.body.appendChild(div);

  // Magic part: Force Uzbek titles in sidebar when ?lang=uz
  if (uzbekMode) {
    document.querySelectorAll(".tree-item-self .tree-item-inner").forEach(el => {
      const link = el.closest("a");
      if (!link) return;
      const fileName = link.href.split("/").pop().replace(".html","");
      const metaTitleUz = el.getAttribute("data-metatitle-uz") || el.textContent; // we will set this below
      if (metaTitleUz.trim()) el.textContent = metaTitleUz;
    });

    // Inject Uzbek titles from frontmatter (runs once)
    document.querySelectorAll("meta[property='og:title'], meta[name='title']").forEach(meta => {
      const uzTitle = meta.content; // already set by dg-metatitle when lang=uz
      if (uzTitle) document.title = uzTitle;
    });
  }
});
</script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" referrerpolicy="no-referrer" async/>
<script src="https://fastly.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" async></script>

<link href="/styles/digital-garden-base.css" rel="stylesheet">
{%-if meta.themeStyle%}
    <link href="/styles/obsidian-base.css" rel="stylesheet">
    <link href="{{meta.themeStyle}}" rel="stylesheet">
{% else %}
    <link href="/styles/style.css" rel="stylesheet">
{%endif%}

<link href="/styles/custom-style.css" rel="stylesheet">
{%- for style in dynamics.styles -%}
<link href="{{style}}" rel="stylesheet">
{%- endfor -%}

{% favicons './src/site/favicon.svg', appleIconBgColor='#123' %}

{% if metatags %}
    {% for name, content in metatags %}
        <meta name="{{ name }}" content="{{ content }}">
    {% endfor %}
{% endif %}

{% if meta.styleSettingsCss %}
    <style>
        {{ meta.styleSettingsCss | safe }}
    </style>
{% endif %}
<style>
</style>
